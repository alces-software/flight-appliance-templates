{"Description":"Launch an Alces Flight Compute HPC environment with a single on-demand login node and multiple compute nodes optionally using EC2 Spot instances.","Metadata":{"AWS::CloudFormation::Interface":{"ParameterGroups":[{"Label":{"default":"Access and security"},"Parameters":["AccessUsername","AccessKeyName","AccessNetwork"]},{"Label":{"default":"Alces Flight configuration and customization"},"Parameters":["FlightSchedulerType","FlightPreloadSoftware","FlightFeatures","FlightProfileBucket","FlightProfiles"]},{"Label":{"default":"Primary node configuration"},"Parameters":["LoginInstanceType","LoginInstanceTypeOther"]},{"Label":{"default":"Compute estate"},"Parameters":["ComputeInstanceType","ComputeInstanceTypeOther","ComputeSpotPrice","ComputeAutoscalingPolicy","ComputeInitialNodes","ComputeMaxNodes"]},{"Label":{"default":"Disks and storage"},"Parameters":["VolumeLayout","VolumeEncryptionPolicy","LoginSystemVolumeSize","LoginSystemVolumeType","HomeVolumeSize","AppsVolumeSize","HomeVolumeType","AppsVolumeType","ComputeSystemVolumeType"]}],"ParameterLabels":{"FlightProfileBucket":{"default":"S3 bucket for customization profiles"},"AccessNetwork":{"default":"Access network address"},"LoginInstanceType":{"default":"Login node instance type"},"LoginInstanceTypeOther":{"default":"Specific login node instance type"},"LoginSystemVolumeSize":{"default":"Login node system volume size"},"LoginSystemVolumeType":{"default":"Login node system volume disk type"},"HomeVolumeSize":{"default":"Home volume disk size"},"HomeVolumeType":{"default":"Home volume disk type"},"AppsVolumeSize":{"default":"Application volume disk size"},"AppsVolumeType":{"default":"Application volume disk type"},"AccessKeyName":{"default":"Cluster administrator keypair"},"AccessUsername":{"default":"Cluster administrator username"},"FlightProfiles":{"default":"Customization profiles to enable"},"FlightFeatures":{"default":"Additional features to enable"},"FlightSchedulerType":{"default":"HPC job scheduler"},"FlightPreloadSoftware":{"default":"Preload software"},"ComputeInstanceType":{"default":"Compute instance type"},"ComputeInstanceTypeOther":{"default":"Specific compute instance type"},"VolumeEncryptionPolicy":{"default":"Data volume encryption policy"},"VolumeLayout":{"default":"Data volume layout"},"ComputeAutoscalingPolicy":{"default":"Autoscaling policy"},"ComputeSystemVolumeType":{"default":"Compute node system volume disk type"},"ComputeSpotPrice":{"default":"Spot price"},"ComputeInitialNodes":{"default":"Initial compute nodes (autoscaling)"},"ComputeMaxNodes":{"default":"Initial/maximum compute nodes"}}}},"Parameters":{"FlightProfileBucket":{"Description":"S3 bucket name (without s3:// prefix) containing Alces Flight Compute customization profiles or leave blank for account default.","Type":"String","ConstraintDescription":"Customization profile bucket name must be a valid S3 bucket name (do not include the s3:// prefix) or be left blank.","AllowedPattern":"(|^[a-z0-9][-.a-z0-9][-.a-z0-9]*[a-z0-9]$)"},"AccessNetwork":{"Description":"An IP network range (CIDR) that is permitted to access the cluster login node; e.g. entering 0.0.0.0/0 will allow anyone to login using the AWS key specified.","Type":"String","ConstraintDescription":"Please specify a valid CIDR, e.g. 0.0.0.0/0","AllowedPattern":"^[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}/[0-9]{1,2}"},"LoginInstanceType":{"Description":"The login node instance type to deploy. This defines the number of cores and amount of memory available. If you want to specify a particular instance type, select 'other' and choose a value in the 'Specific login node instance type' field below.","Type":"String","Default":"medium-r3.2xlarge","AllowedValues":["small-t2.large","medium-r3.2xlarge","large-c4.8xlarge","gpu-g2.2xlarge","enterprise-x1.32xlarge","other"]},"LoginInstanceTypeOther":{"Description":"If you have selected 'other' above, you can select your specific login node instance type here.","Type":"String","Default":"r3.2xlarge-8C-61GB","AllowedValues":["t2.nano-1C-0.5GB","t2.micro-1C-1GB","t2.small-1C-2GB","t2.medium-2C-4GB","t2.large-2C-8GB","m4.large-2C-8GB","m4.xlarge-4C-16GB","m4.2xlarge-8C-32GB","m4.4xlarge-16C-64GB","m4.10xlarge-40C-160GB","m4.16xlarge-64C-256GB","m3.medium-1C-3.75GB","m3.large-2C-7.5GB","m3.xlarge-4C-15GB","m3.2xlarge-8C-30GB","c4.large-2C-3.75GB","c4.xlarge-4C-7.5GB","c4.2xlarge-8C-15GB","c4.4xlarge-16C-30GB","c4.8xlarge-36C-60GB","c3.large-2C-3.75GB","c3.xlarge-4C-7.5GB","c3.2xlarge-8C-15GB","c3.4xlarge-16C-30GB","c3.8xlarge-32C-60GB","g2.2xlarge-1GPU-8C-15GB","g2.8xlarge-4GPU-32C-60GB","x1.32xlarge-128C-1952GB","r3.large-2C-15.25GB","r3.xlarge-4C-30.5GB","r3.2xlarge-8C-61GB","r3.4xlarge-16C-122GB","r3.8xlarge-32C-244GB","i2.xlarge-4C-30.5GB","i2.2xlarge-8C-61GB","i2.4xlarge-16C-122GB","i2.8xlarge-32C-244GB","d2.xlarge-4C-30.5GB","d2.2xlarge-8C-61GB","d2.4xlarge-16C-122GB","d2.8xlarge-36C-244GB"]},"LoginSystemVolumeSize":{"Description":"The desired size (in GB) of the system volume. When using the 'standard' layout, this defines the amount of user and application storage available. NB. When using the 'standard' disk type, size must not exceed 1024GB.","Type":"Number","Default":"500","MinValue":"16","MaxValue":"16384"},"LoginSystemVolumeType":{"Description":"The backing disk technology for the login node system volume.","Type":"String","Default":"magnetic.standard","AllowedValues":["magnetic.standard","general-purpose-ssd.gp2"]},"HomeVolumeSize":{"Description":"The desired size (in GB) of the home volume. When using the 'discrete.home' layout, this defines the amount of user storage available, otherwise it is ignored. NB. When using the 'st1' or 'sc1' disk type, size must be at least 500GB. When using the 'standard' disk type, size must not exceed 1024GB.","Type":"Number","Default":"400","MinValue":"1","MaxValue":"16384"},"HomeVolumeType":{"Description":"The backing disk technology for the discrete home EBS volume. Only effective when using a 'discrete.home' layout.","Type":"String","Default":"magnetic.standard","AllowedValues":["magnetic.standard","general-purpose-ssd.gp2","throughput-optimized-hdd.st1","cold-hdd.sc1"]},"AppsVolumeSize":{"Description":"The desired size (in GB) of the applications volume. When using the 'discrete.apps' layout, this defines the amount of application storage available, otherwise it is ignored. NB. When using the 'st1' or 'sc1' disk type, size must be at least 500GB. When using the 'standard' disk type, size must not exceed 1024GB.","Type":"Number","Default":"100","MinValue":"1","MaxValue":"16384"},"AppsVolumeType":{"Description":"The backing disk technology for the discrete applications EBS volume. Only effective when using a 'discrete.apps' layout.","Type":"String","Default":"magnetic.standard","AllowedValues":["magnetic.standard","general-purpose-ssd.gp2","throughput-optimized-hdd.st1","cold-hdd.sc1"]},"AccessKeyName":{"Description":"AWS key for access to the cluster administrator account.","Type":"AWS::EC2::KeyPair::KeyName"},"AccessUsername":{"Description":"Username for the cluster administrator account.","Type":"String","Default":"alces","ConstraintDescription":"Enter a username between 1 and 16 characters using a-z, 1 to 9 and -","AllowedPattern":"[-a-z0-9]*","MaxLength":"16","MinLength":"1"},"FlightProfiles":{"Description":"Alces Flight Compute customization profile names separated by spaces or leave blank for default.","Type":"String"},"FlightFeatures":{"Description":"Alces Flight Compute feature names separated by spaces or leave blank.","Type":"String"},"FlightSchedulerType":{"Description":"HPC job scheduler to configure for use within this cluster.","Type":"String","Default":"gridscheduler","AllowedValues":["gridscheduler","openlava","pbspro","slurm","torque"]},"FlightPreloadSoftware":{"Description":"Alces Gridware depot (software set) to preload.","Type":"String","Default":"-none-","AllowedValues":["-none-","benchmark","bioinformatics","cfd","chemistry","development"]},"ComputeInstanceType":{"Description":"The compute node instance type to deploy. This defines the number of cores and amount of memory available. If you want to specify a particular instance type select 'other' and choose a value in the 'Specific compute instance type' field below.","Type":"String","Default":"compute-2C-3.75GB.small-c4.large","AllowedValues":["compute-2C-3.75GB.small-c4.large","compute-8C-15GB.medium-c4.2xlarge","compute-16C-30GB.large-c4.4xlarge","compute-36C-60GB.dedicated-c4.8xlarge","balanced-4C-16GB.small-m4.xlarge","balanced-8C-32GB.medium-m4.2xlarge","balanced-16C-64GB.large-m4.4xlarge","balanced-40C-160GB.dedicated-m4.10xlarge","memory-4C-30GB.small-r3.xlarge","memory-8C-60GB.medium-r3.2xlarge","memory-16C-120GB.large-r3.4xlarge","memory-32C-240GB.dedicated-r3.8xlarge","gpu-1GPU-8C-15GB.medium-g2.2xlarge","gpu-4GPU-32C-60GB.dedicated-g2.8xlarge","enterprise-128C-1952GB.dedicated-x1.32xlarge","other"]},"ComputeInstanceTypeOther":{"Description":"If you have selected 'other' above, you can select your specific compute instance type here.","Type":"String","Default":"c4.large-2C-3.75GB","AllowedValues":["t2.nano-1C-0.5GB","t2.micro-1C-1GB","t2.small-1C-2GB","t2.medium-2C-4GB","t2.large-2C-8GB","m4.large-2C-8GB","m4.xlarge-4C-16GB","m4.2xlarge-8C-32GB","m4.4xlarge-16C-64GB","m4.10xlarge-40C-160GB","m4.16xlarge-64C-256GB","m3.medium-1C-3.75GB","m3.large-2C-7.5GB","m3.xlarge-4C-15GB","m3.2xlarge-8C-30GB","c4.large-2C-3.75GB","c4.xlarge-4C-7.5GB","c4.2xlarge-8C-15GB","c4.4xlarge-16C-30GB","c4.8xlarge-36C-60GB","c3.large-2C-3.75GB","c3.xlarge-4C-7.5GB","c3.2xlarge-8C-15GB","c3.4xlarge-16C-30GB","c3.8xlarge-32C-60GB","g2.2xlarge-1GPU-8C-15GB","g2.8xlarge-4GPU-32C-60GB","x1.32xlarge-128C-1952GB","r3.large-2C-15.25GB","r3.xlarge-4C-30.5GB","r3.2xlarge-8C-61GB","r3.4xlarge-16C-122GB","r3.8xlarge-32C-244GB","i2.xlarge-4C-30.5GB","i2.2xlarge-8C-61GB","i2.4xlarge-16C-122GB","i2.8xlarge-32C-244GB","d2.xlarge-4C-30.5GB","d2.2xlarge-8C-61GB","d2.4xlarge-16C-122GB","d2.8xlarge-36C-244GB"]},"VolumeEncryptionPolicy":{"Description":"The disk encryption policy for the discrete EBS volumes on your login node. NB. the system disk is not affected by this option as it cannot be encrypted. Only effective when using a 'discrete.home' or 'discrete.apps' layout.","Type":"String","Default":"unencrypted","AllowedValues":["encrypted","unencrypted"]},"VolumeLayout":{"Description":"The data volume layout. Choose 'standard' for a single (unencrypted) volume, or choose to have 'home' or 'apps' volumes configured discretely.","Type":"String","Default":"standard","AllowedValues":["standard","discrete.home","discrete.apps","discrete.home-discrete.apps"]},"ComputeAutoscalingPolicy":{"Description":"Enable or disable built-in scaling. When enabled Flight will shut down nodes when they are idle or start further nodes when jobs are queued. (NB. if enabled you may also want to modify the value for 'Initial compute nodes').","Type":"String","Default":"disabled","AllowedValues":["disabled","enabled"]},"ComputeSystemVolumeType":{"Description":"The backing disk technology for compute node system volumes.","Type":"String","Default":"magnetic.standard","AllowedValues":["magnetic.standard","general-purpose-ssd.gp2"]},"ComputeSpotPrice":{"Description":"Your maximum bid per hour for each compute instance. View the Spot Bid Advisor <https://aws.amazon.com/ec2/spot/bid-advisor/> for information on spot pricing. Enter '0' to use on-demand pricing.","Type":"Number","Default":"0","MinValue":"0"},"ComputeInitialNodes":{"Description":"The number of compute nodes that should be started initially when 'Autoscaling policy' is set to 'enabled'. Must be between 0 and 32. (NB. this value is only used when 'Autoscaling policy' is set to 'enabled'. Specify 'Initial/maximum compute nodes' below when 'Autoscaling policy' is set to 'disabled').","Type":"Number","Default":"1","MinValue":"0","MaxValue":"32"},"ComputeMaxNodes":{"Description":"The number of compute nodes in your cluster. Must be between 1 and 32. (NB. when 'Autoscaling policy' is set to 'enabled' this value represents the maximum number of compute nodes that may be automatically started. Specify 'Initial compute nodes (autoscaling)' to select how many nodes you want to start initially).","Type":"Number","Default":"4","MinValue":"1","MaxValue":"32"}},"Conditions":{"HasProfileBucket":{"Fn::Not":[{"Fn::Equals":[{"Ref":"FlightProfileBucket"},""]}]},"HasLoginInstanceTypeOther":{"Fn::Equals":[{"Ref":"LoginInstanceType"},"other"]},"HasComputeInstanceTypeOther":{"Fn::Equals":[{"Ref":"ComputeInstanceType"},"other"]},"HasComputePlacement":{"Fn::Or":[{"Fn::And":[{"Condition":"HasComputeInstanceTypeOther"},{"Fn::Equals":[{"Fn::FindInMap":["FlightInstanceDescriptors",{"Ref":"ComputeInstanceTypeOther"},"PlacementAvailable"]},true]}]},{"Fn::And":[{"Fn::Not":[{"Condition":"HasComputeInstanceTypeOther"}]},{"Fn::Equals":[{"Fn::FindInMap":["FlightInstanceDescriptors",{"Fn::FindInMap":["FlightComputeTypes",{"Ref":"ComputeInstanceType"},"InstanceDescriptor"]},"PlacementAvailable"]},true]}]}]},"HasLoginPlacement":{"Fn::And":[{"Condition":"HasComputePlacement"},{"Fn::Or":[{"Fn::And":[{"Condition":"HasLoginInstanceTypeOther"},{"Fn::Equals":[{"Fn::FindInMap":["FlightInstanceDescriptors",{"Ref":"LoginInstanceTypeOther"},"PlacementAvailable"]},true]}]},{"Fn::And":[{"Fn::Not":[{"Condition":"HasLoginInstanceTypeOther"}]},{"Fn::Equals":[{"Fn::FindInMap":["FlightInstanceDescriptors",{"Fn::FindInMap":["FlightLoginTypes",{"Ref":"LoginInstanceType"},"InstanceDescriptor"]},"PlacementAvailable"]},true]}]}]}]},"HasEncryptedVolumes":{"Fn::Equals":[{"Ref":"VolumeEncryptionPolicy"},"encrypted"]},"HasDiscreteHomeApps":{"Fn::Equals":[{"Ref":"VolumeLayout"},"discrete.home-discrete.apps"]},"HasDiscreteHome":{"Fn::Equals":[{"Ref":"VolumeLayout"},"discrete.home"]},"HasDiscreteApps":{"Fn::Equals":[{"Ref":"VolumeLayout"},"discrete.apps"]},"HasProfiles":{"Fn::Not":[{"Fn::Equals":[{"Ref":"FlightProfiles"},""]}]},"HasProfileOptions":{"Fn::Or":[{"Condition":"HasProfileBucket"},{"Condition":"HasProfiles"}]},"HasAutoscaling":{"Fn::Equals":[{"Ref":"ComputeAutoscalingPolicy"},"enabled"]},"HasDiscreteVolumes":{"Fn::Or":[{"Condition":"HasDiscreteHome"},{"Condition":"HasDiscreteApps"},{"Condition":"HasDiscreteHomeApps"}]},"HasGridwareDepot":{"Fn::Not":[{"Fn::Equals":[{"Ref":"FlightPreloadSoftware"},"-none-"]}]},"HasSpot":{"Fn::Not":[{"Fn::Equals":[{"Ref":"ComputeSpotPrice"},"0"]}]},"HasZeroNodes":{"Fn::And":[{"Condition":"HasAutoscaling"},{"Fn::Equals":[{"Ref":"ComputeInitialNodes"},"0"]}]}},"Mappings":{"FlightRegionParameters":{"ap-northeast-1":{"AMI":"","AvailabilityList":"all"},"ap-northeast-2":{"AMI":"","AvailabilityList":"no.g2-x1-m3-c3"},"ap-south-1":{"AMI":"","AvailabilityList":"no.g2-x1-m3-c3"},"ap-southeast-1":{"AMI":"","AvailabilityList":"all"},"ap-southeast-2":{"AMI":"","AvailabilityList":"all"},"eu-central-1":{"AMI":"","AvailabilityList":"all"},"eu-west-1":{"AMI":"ami-3df6b14e","AvailabilityList":"all"},"sa-east-1":{"AMI":"","AvailabilityList":"no.g2-x1-i2-d2-some.r3"},"us-east-1":{"AMI":"","AvailabilityList":"all"},"us-west-1":{"AMI":"","AvailabilityList":"no.x1"},"us-west-2":{"AMI":"","AvailabilityList":"all"}},"DiskTypes":{"magnetic.standard":{"VolumeType":"standard"},"general-purpose-ssd.gp2":{"VolumeType":"gp2"},"throughput-optimized-hdd.st1":{"VolumeType":"st1"},"cold-hdd.sc1":{"VolumeType":"sc1"},"provisioned-iops-ssd.io1":{"VolumeType":"io1"}},"FlightInstanceTypeAvailability":{"no.g2-x1-m3-c3":{"NULL":"","t2nano":"t2.nano","t2micro":"t2.micro","t2small":"t2.small","t2medium":"t2.medium","t2large":"t2.large","m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","r3large":"r3.large","r3xlarge":"r3.xlarge","r32xlarge":"r3.2xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge","i2xlarge":"i2.xlarge","i22xlarge":"i2.2xlarge","i24xlarge":"i2.4xlarge","i28xlarge":"i2.8xlarge","d2xlarge":"d2.xlarge","d22xlarge":"d2.2xlarge","d24xlarge":"d2.4xlarge","d28xlarge":"d2.8xlarge"},"no.g2-x1-i2-d2-some.r3":{"NULL":"","t2nano":"t2.nano","t2micro":"t2.micro","t2small":"t2.small","t2medium":"t2.medium","t2large":"t2.large","m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","m3medium":"m3.medium","m3large":"m3.large","m3xlarge":"m3.xlarge","m32xlarge":"m3.2xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","c3large":"c3.large","c3xlarge":"c3.xlarge","c32xlarge":"c3.2xlarge","c34xlarge":"c3.4xlarge","c38xlarge":"c3.8xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge"},"no.x1":{"NULL":"","t2nano":"t2.nano","t2micro":"t2.micro","t2small":"t2.small","t2medium":"t2.medium","t2large":"t2.large","m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","m3medium":"m3.medium","m3large":"m3.large","m3xlarge":"m3.xlarge","m32xlarge":"m3.2xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","c3large":"c3.large","c3xlarge":"c3.xlarge","c32xlarge":"c3.2xlarge","c34xlarge":"c3.4xlarge","c38xlarge":"c3.8xlarge","g22xlarge":"g2.4xlarge","g28xlarge":"g2.8xlarge","r3large":"r3.large","r3xlarge":"r3.xlarge","r32xlarge":"r3.2xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge","i2xlarge":"i2.xlarge","i22xlarge":"i2.2xlarge","i24xlarge":"i2.4xlarge","i28xlarge":"i2.8xlarge","d2xlarge":"d2.xlarge","d22xlarge":"d2.2xlarge","d24xlarge":"d2.4xlarge","d28xlarge":"d2.8xlarge"},"all":{"NULL":"","t2nano":"t2.nano","t2micro":"t2.micro","t2small":"t2.small","t2medium":"t2.medium","t2large":"t2.large","m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","m3medium":"m3.medium","m3large":"m3.large","m3xlarge":"m3.xlarge","m32xlarge":"m3.2xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","c3large":"c3.large","c3xlarge":"c3.xlarge","c32xlarge":"c3.2xlarge","c34xlarge":"c3.4xlarge","c38xlarge":"c3.8xlarge","g22xlarge":"g2.4xlarge","g28xlarge":"g2.8xlarge","x132xlarge":"x1.32xlarge","r3large":"r3.large","r3xlarge":"r3.xlarge","r32xlarge":"r3.2xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge","i2xlarge":"i2.xlarge","i22xlarge":"i2.2xlarge","i24xlarge":"i2.4xlarge","i28xlarge":"i2.8xlarge","d2xlarge":"d2.xlarge","d22xlarge":"d2.2xlarge","d24xlarge":"d2.4xlarge","d28xlarge":"d2.8xlarge"}},"FlightInstanceDescriptors":{"NULL":{"Key":"NULL","PlacementAvailable":"NULL","InstanceStorage":"NULL"},"t2.nano-1C-0.5GB":{"Key":"t2nano","PlacementAvailable":false,"InstanceStorage":false},"t2.micro-1C-1GB":{"Key":"t2micro","PlacementAvailable":false,"InstanceStorage":false},"t2.small-1C-2GB":{"Key":"t2small","PlacementAvailable":false,"InstanceStorage":false},"t2.medium-2C-4GB":{"Key":"t2medium","PlacementAvailable":false,"InstanceStorage":false},"t2.large-2C-8GB":{"Key":"t2large","PlacementAvailable":false,"InstanceStorage":false},"m4.large-2C-8GB":{"Key":"m4large","PlacementAvailable":true,"InstanceStorage":false},"m4.xlarge-4C-16GB":{"Key":"m4xlarge","PlacementAvailable":true,"InstanceStorage":false},"m4.2xlarge-8C-32GB":{"Key":"m42xlarge","PlacementAvailable":true,"InstanceStorage":false},"m4.4xlarge-16C-64GB":{"Key":"m44xlarge","PlacementAvailable":true,"InstanceStorage":false},"m4.10xlarge-40C-160GB":{"Key":"m410xlarge","PlacementAvailable":true,"InstanceStorage":false},"m4.16xlarge-64C-256GB":{"Key":"m416xlarge","PlacementAvailable":true,"InstanceStorage":false},"m3.medium-1C-3.75GB":{"Key":"m3medium","PlacementAvailable":false,"InstanceStorage":true},"m3.large-2C-7.5GB":{"Key":"m3large","PlacementAvailable":false,"InstanceStorage":true},"m3.xlarge-4C-15GB":{"Key":"m3xlarge","PlacementAvailable":false,"InstanceStorage":true},"m3.2xlarge-8C-30GB":{"Key":"m32xlarge","PlacementAvailable":false,"InstanceStorage":true},"c4.large-2C-3.75GB":{"Key":"c4large","PlacementAvailable":true,"InstanceStorage":false},"c4.xlarge-4C-7.5GB":{"Key":"c4xlarge","PlacementAvailable":true,"InstanceStorage":false},"c4.2xlarge-8C-15GB":{"Key":"c42xlarge","PlacementAvailable":true,"InstanceStorage":false},"c4.4xlarge-16C-30GB":{"Key":"c44xlarge","PlacementAvailable":true,"InstanceStorage":false},"c4.8xlarge-36C-60GB":{"Key":"c48xlarge","PlacementAvailable":true,"InstanceStorage":false},"c3.large-2C-3.75GB":{"Key":"c3large","PlacementAvailable":true,"InstanceStorage":true},"c3.xlarge-4C-7.5GB":{"Key":"c3xlarge","PlacementAvailable":true,"InstanceStorage":true},"c3.2xlarge-8C-15GB":{"Key":"c32xlarge","PlacementAvailable":true,"InstanceStorage":true},"c3.4xlarge-16C-30GB":{"Key":"c34xlarge","PlacementAvailable":true,"InstanceStorage":true},"c3.8xlarge-32C-60GB":{"Key":"c38xlarge","PlacementAvailable":true,"InstanceStorage":true},"g2.2xlarge-1GPU-8C-15GB":{"Key":"g24xlarge","PlacementAvailable":true,"InstanceStorage":true},"g2.8xlarge-4GPU-32C-60GB":{"Key":"g28xlarge","PlacementAvailable":true,"InstanceStorage":true},"x1.32xlarge-128C-1952GB":{"Key":"x132xlarge","PlacementAvailable":true,"InstanceStorage":true},"r3.large-2C-15.25GB":{"Key":"r3large","PlacementAvailable":true,"InstanceStorage":true},"r3.xlarge-4C-30.5GB":{"Key":"r3xlarge","PlacementAvailable":true,"InstanceStorage":true},"r3.2xlarge-8C-61GB":{"Key":"r32xlarge","PlacementAvailable":true,"InstanceStorage":true},"r3.4xlarge-16C-122GB":{"Key":"r34xlarge","PlacementAvailable":true,"InstanceStorage":true},"r3.8xlarge-32C-244GB":{"Key":"r38xlarge","PlacementAvailable":true,"InstanceStorage":true},"i2.xlarge-4C-30.5GB":{"Key":"i2xlarge","PlacementAvailable":true,"InstanceStorage":true},"i2.2xlarge-8C-61GB":{"Key":"i22xlarge","PlacementAvailable":true,"InstanceStorage":true},"i2.4xlarge-16C-122GB":{"Key":"i24xlarge","PlacementAvailable":true,"InstanceStorage":true},"i2.8xlarge-32C-244GB":{"Key":"i28xlarge","PlacementAvailable":true,"InstanceStorage":true},"d2.xlarge-4C-30.5GB":{"Key":"d2xlarge","PlacementAvailable":true,"InstanceStorage":true},"d2.2xlarge-8C-61GB":{"Key":"d22xlarge","PlacementAvailable":true,"InstanceStorage":true},"d2.4xlarge-16C-122GB":{"Key":"d24xlarge","PlacementAvailable":true,"InstanceStorage":true},"d2.8xlarge-36C-244GB":{"Key":"d28xlarge","PlacementAvailable":true,"InstanceStorage":true}},"FlightLoginTypes":{"small-t2.large":{"InstanceDescriptor":"t2.large-2C-8GB"},"medium-r3.2xlarge":{"InstanceDescriptor":"r3.2xlarge-8C-61GB"},"large-c4.8xlarge":{"InstanceDescriptor":"c4.8xlarge-36C-60GB"},"gpu-g2.2xlarge":{"InstanceDescriptor":"g2.2xlarge-1GPU-8C-15GB"},"enterprise-x1.32xlarge":{"InstanceDescriptor":"x1.32xlarge-128C-1952GB"},"other":{"InstanceDescriptor":"NULL"}},"FlightSpotAvailability":{"no.g2-x1-m3-c3":{"m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","r3large":"r3.large","r3xlarge":"r3.xlarge","r32xlarge":"r3.2xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge","i2xlarge":"i2.xlarge","i22xlarge":"i2.2xlarge","i24xlarge":"i2.4xlarge","i28xlarge":"i2.8xlarge","d2xlarge":"d2.xlarge","d22xlarge":"d2.2xlarge","d24xlarge":"d2.4xlarge","d28xlarge":"d2.8xlarge"},"no.g2-x1-i2-d2-some.r3":{"m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","m3medium":"m3.medium","m3large":"m3.large","m3xlarge":"m3.xlarge","m32xlarge":"m3.2xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","c3large":"c3.large","c3xlarge":"c3.xlarge","c32xlarge":"c3.2xlarge","c34xlarge":"c3.4xlarge","c38xlarge":"c3.8xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge"},"no.x1":{"m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","m3medium":"m3.medium","m3large":"m3.large","m3xlarge":"m3.xlarge","m32xlarge":"m3.2xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","c3large":"c3.large","c3xlarge":"c3.xlarge","c32xlarge":"c3.2xlarge","c34xlarge":"c3.4xlarge","c38xlarge":"c3.8xlarge","g22xlarge":"g2.4xlarge","g28xlarge":"g2.8xlarge","r3large":"r3.large","r3xlarge":"r3.xlarge","r32xlarge":"r3.2xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge","i2xlarge":"i2.xlarge","i22xlarge":"i2.2xlarge","i24xlarge":"i2.4xlarge","i28xlarge":"i2.8xlarge","d2xlarge":"d2.xlarge","d22xlarge":"d2.2xlarge","d24xlarge":"d2.4xlarge","d28xlarge":"d2.8xlarge"},"all":{"m4large":"m4.large","m4xlarge":"m4.xlarge","m42xlarge":"m4.2xlarge","m44xlarge":"m4.4xlarge","m410xlarge":"m4.10xlarge","m416xlarge":"m4.16xlarge","m3medium":"m3.medium","m3large":"m3.large","m3xlarge":"m3.xlarge","m32xlarge":"m3.2xlarge","c4large":"c4.large","c4xlarge":"c4.xlarge","c42xlarge":"c4.2xlarge","c44xlarge":"c4.4xlarge","c48xlarge":"c4.8xlarge","c3large":"c3.large","c3xlarge":"c3.xlarge","c32xlarge":"c3.2xlarge","c34xlarge":"c3.4xlarge","c38xlarge":"c3.8xlarge","g22xlarge":"g2.4xlarge","g28xlarge":"g2.8xlarge","x132xlarge":"x1.32xlarge","r3large":"r3.large","r3xlarge":"r3.xlarge","r32xlarge":"r3.2xlarge","r34xlarge":"r3.4xlarge","r38xlarge":"r3.8xlarge","i2xlarge":"i2.xlarge","i22xlarge":"i2.2xlarge","i24xlarge":"i2.4xlarge","i28xlarge":"i2.8xlarge","d2xlarge":"d2.xlarge","d22xlarge":"d2.2xlarge","d24xlarge":"d2.4xlarge","d28xlarge":"d2.8xlarge"}},"FlightComputeTypes":{"compute-2C-3.75GB.small-c4.large":{"InstanceDescriptor":"c4.large-2C-3.75GB"},"compute-8C-15GB.medium-c4.2xlarge":{"InstanceDescriptor":"c4.2xlarge-8C-15GB"},"compute-16C-30GB.large-c4.4xlarge":{"InstanceDescriptor":"c4.4xlarge-16C-30GB"},"compute-36C-60GB.dedicated-c4.8xlarge":{"InstanceDescriptor":"c4.8xlarge-36C-60GB"},"balanced-4C-16GB.small-m4.xlarge":{"InstanceDescriptor":"m4.xlarge-4C-16GB"},"balanced-8C-32GB.medium-m4.2xlarge":{"InstanceDescriptor":"m4.2xlarge-8C-32GB"},"balanced-16C-64GB.large-m4.4xlarge":{"InstanceDescriptor":"m4.4xlarge-16C-64GB"},"balanced-40C-160GB.dedicated-m4.10xlarge":{"InstanceDescriptor":"m4.10xlarge-40C-160GB"},"memory-4C-30GB.small-r3.xlarge":{"InstanceDescriptor":"r3.xlarge-4C-30.5GB"},"memory-8C-60GB.medium-r3.2xlarge":{"InstanceDescriptor":"r3.2xlarge-8C-61GB"},"memory-16C-120GB.large-r3.4xlarge":{"InstanceDescriptor":"r3.4xlarge-16C-122GB"},"memory-32C-240GB.dedicated-r3.8xlarge":{"InstanceDescriptor":"r3.8xlarge-32C-244GB"},"gpu-1GPU-8C-15GB.medium-g2.2xlarge":{"InstanceDescriptor":"g2.2xlarge-1GPU-8C-15GB"},"gpu-4GPU-32C-60GB.dedicated-g2.8xlarge":{"InstanceDescriptor":"g2.8xlarge-4GPU-32C-60GB"},"enterprise-128C-1952GB.dedicated-x1.32xlarge":{"InstanceDescriptor":"x1.32xlarge-128C-1952GB"},"other":{"InstanceDescriptor":"NULL"}}},"Resources":{"FlightReadyHandle":{"Type":"AWS::CloudFormation::WaitConditionHandle"},"FlightReadyCondition":{"Type":"AWS::CloudFormation::WaitCondition","Properties":{"Handle":{"Ref":"FlightReadyHandle"},"Timeout":"1800"}},"FlightVPC":{"Type":"AWS::EC2::VPC","Properties":{"Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}],"CidrBlock":"10.75.0.0/16","EnableDnsSupport":"true","EnableDnsHostnames":"true"}},"FlightGW":{"Type":"AWS::EC2::InternetGateway"},"FlightGWAttach":{"Type":"AWS::EC2::VPCGatewayAttachment","Properties":{"VpcId":{"Ref":"FlightVPC"},"InternetGatewayId":{"Ref":"FlightGW"}}},"FlightPublicRouteTable":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"FlightVPC"},"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}}]}},"FlightPublicRoute":{"Type":"AWS::EC2::Route","Properties":{"RouteTableId":{"Ref":"FlightPublicRouteTable"},"DestinationCidrBlock":"0.0.0.0/0","GatewayId":{"Ref":"FlightGW"}}},"FlightPublicNetworkAcl":{"Type":"AWS::EC2::NetworkAcl","Properties":{"VpcId":{"Ref":"FlightVPC"}}},"FlightPublicNetworkAclRuleIngress":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"Egress":false,"CidrBlock":"10.75.129.0/24","Protocol":"-1","RuleAction":"allow","RuleNumber":"100"}},"FlightPublicNetworkAclRuleIngress2":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"Egress":false,"CidrBlock":"10.75.0.0/16","Protocol":"-1","RuleAction":"deny","RuleNumber":"200"}},"FlightPublicNetworkAclRuleIngress3":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"Egress":false,"CidrBlock":"0.0.0.0/0","Protocol":"-1","RuleAction":"allow","RuleNumber":"300"}},"FlightPublicNetworkAclRuleEgress":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"Egress":true,"CidrBlock":"10.75.129.0/24","Protocol":"-1","RuleAction":"allow","RuleNumber":"100"}},"FlightPublicNetworkAclRuleEgress2":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"Egress":true,"CidrBlock":"10.75.0.0/16","Protocol":"-1","RuleAction":"deny","RuleNumber":"200"}},"FlightPublicNetworkAclRuleEgress3":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"Egress":true,"CidrBlock":"0.0.0.0/0","Protocol":"-1","RuleAction":"allow","RuleNumber":"300"}},"FlightPublicNetworkAclAssoc":{"Type":"AWS::EC2::SubnetNetworkAclAssociation","Properties":{"NetworkAclId":{"Ref":"FlightPublicNetworkAcl"},"SubnetId":{"Ref":"FlightPublicSubnet"}}},"FlightPublicSubnet":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"FlightVPC"},"CidrBlock":"10.75.128.0/24","Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-pub-subnet"]]}}]}},"FlightPublicRouteAssoc":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"FlightPublicSubnet"},"RouteTableId":{"Ref":"FlightPublicRouteTable"}}},"FlightLoginIAMRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]}}},"FlightLoginAutoscalingPolicy":{"Type":"AWS::IAM::Policy","Condition":"HasAutoscaling","Properties":{"PolicyName":"MasterAutoscaling","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["cloudwatch:PutMetricData","autoscaling:DescribeAutoScalingGroups","autoscaling:SetDesiredCapacity","autoscaling:UpdateAutoScalingGroup","autoscaling:TerminateInstanceInAutoScalingGroup"],"Resource":["*"]}]},"Roles":[{"Ref":"FlightLoginIAMRole"}]}},"FlightLoginBucketPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"MasterBucketAccess","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:ListBucket","s3:CreateBucket","s3:GetObject","s3:DeleteObject","s3:PutObject"],"Resource":{"Fn::If":["HasProfileBucket",["arn:aws:s3:::alces-flight-*","arn:aws:s3:::alces-flight-*/*",{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"FlightProfileBucket"}]]},{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"FlightProfileBucket"},"/*"]]}],["arn:aws:s3:::alces-flight-*","arn:aws:s3:::alces-flight-*/*"]]}}]},"Roles":[{"Ref":"FlightLoginIAMRole"}]}},"FlightLoginIAMProfile":{"Type":"AWS::IAM::InstanceProfile","Properties":{"Path":"/","Roles":[{"Ref":"FlightLoginIAMRole"}]}},"FlightPlacementGroup":{"Type":"AWS::EC2::PlacementGroup","Properties":{"Strategy":"cluster"}},"FlightLoginSG":{"Type":"AWS::EC2::SecurityGroup","Properties":{"Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}],"GroupDescription":"Enable SSH access to the Alces Clusterware master node","VpcId":{"Ref":"FlightVPC"},"SecurityGroupIngress":[{"IpProtocol":"-1","FromPort":"0","ToPort":"65535","CidrIp":"10.75.0.0/16"},{"IpProtocol":"6","FromPort":"5900","ToPort":"5920","CidrIp":{"Ref":"AccessNetwork"}},{"IpProtocol":"6","FromPort":"22","ToPort":"22","CidrIp":{"Ref":"AccessNetwork"}},{"IpProtocol":"6","FromPort":"80","ToPort":"80","CidrIp":{"Ref":"AccessNetwork"}},{"IpProtocol":"6","FromPort":"443","ToPort":"443","CidrIp":{"Ref":"AccessNetwork"}},{"IpProtocol":"6","FromPort":"1194","ToPort":"1194","CidrIp":{"Ref":"AccessNetwork"}}],"SecurityGroupEgress":[{"IpProtocol":"-1","FromPort":"0","ToPort":"65535","CidrIp":"0.0.0.0/0"}]}},"FlightLogin":{"Type":"AWS::EC2::Instance","DependsOn":["FlightGWAttach"],"Properties":{"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-login1"]]}}],"SourceDestCheck":false,"IamInstanceProfile":{"Ref":"FlightLoginIAMProfile"},"PlacementGroupName":{"Fn::If":["HasLoginPlacement",{"Ref":"FlightPlacementGroup"},{"Ref":"AWS::NoValue"}]},"ImageId":{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AMI"]},"NetworkInterfaces":[{"AssociatePublicIpAddress":"True","DeviceIndex":"0","GroupSet":[{"Ref":"FlightLoginSG"}],"SubnetId":{"Ref":"FlightPublicSubnet"}}],"BlockDeviceMappings":{"Fn::If":["HasDiscreteHomeApps",[{"DeviceName":"/dev/sda1","Ebs":{"VolumeSize":{"Ref":"LoginSystemVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"LoginSystemVolumeType"},"VolumeType"]}}},{"DeviceName":"/dev/sdp","Ebs":{"VolumeSize":{"Ref":"HomeVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"HomeVolumeType"},"VolumeType"]},"Encrypted":{"Fn::If":["HasEncryptedVolumes",true,false]}}},{"DeviceName":"/dev/sdq","Ebs":{"VolumeSize":{"Ref":"AppsVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"AppsVolumeType"},"VolumeType"]},"Encrypted":{"Fn::If":["HasEncryptedVolumes",true,false]}}},{"DeviceName":"/dev/xvdb","VirtualName":"ephemeral0"},{"DeviceName":"/dev/xvdc","VirtualName":"ephemeral1"},{"DeviceName":"/dev/xvdd","VirtualName":"ephemeral2"},{"DeviceName":"/dev/xvde","VirtualName":"ephemeral3"}],{"Fn::If":["HasDiscreteHome",[{"DeviceName":"/dev/sda1","Ebs":{"VolumeSize":{"Ref":"LoginSystemVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"LoginSystemVolumeType"},"VolumeType"]}}},{"DeviceName":"/dev/sdp","Ebs":{"VolumeSize":{"Ref":"HomeVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"HomeVolumeType"},"VolumeType"]},"Encrypted":{"Fn::If":["HasEncryptedVolumes",true,false]}}},{"DeviceName":"/dev/xvdb","VirtualName":"ephemeral0"},{"DeviceName":"/dev/xvdc","VirtualName":"ephemeral1"},{"DeviceName":"/dev/xvdd","VirtualName":"ephemeral2"},{"DeviceName":"/dev/xvde","VirtualName":"ephemeral3"}],{"Fn::If":["HasDiscreteApps",[{"DeviceName":"/dev/sda1","Ebs":{"VolumeSize":{"Ref":"LoginSystemVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"LoginSystemVolumeType"},"VolumeType"]}}},{"DeviceName":"/dev/sdq","Ebs":{"VolumeSize":{"Ref":"AppsVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"AppsVolumeType"},"VolumeType"]},"Encrypted":{"Fn::If":["HasEncryptedVolumes",true,false]}}},{"DeviceName":"/dev/xvdb","VirtualName":"ephemeral0"},{"DeviceName":"/dev/xvdc","VirtualName":"ephemeral1"},{"DeviceName":"/dev/xvdd","VirtualName":"ephemeral2"},{"DeviceName":"/dev/xvde","VirtualName":"ephemeral3"}],[{"DeviceName":"/dev/sda1","Ebs":{"VolumeSize":{"Ref":"LoginSystemVolumeSize"},"VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"LoginSystemVolumeType"},"VolumeType"]}}},{"DeviceName":"/dev/xvdb","VirtualName":"ephemeral0"},{"DeviceName":"/dev/xvdc","VirtualName":"ephemeral1"},{"DeviceName":"/dev/xvdd","VirtualName":"ephemeral2"},{"DeviceName":"/dev/xvde","VirtualName":"ephemeral3"}]]}]}]},"InstanceType":{"Fn::If":["HasLoginInstanceTypeOther",{"Fn::FindInMap":["FlightInstanceTypeAvailability",{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AvailabilityList"]},{"Fn::FindInMap":["FlightInstanceDescriptors",{"Ref":"LoginInstanceTypeOther"},"Key"]}]},{"Fn::FindInMap":["FlightInstanceTypeAvailability",{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AvailabilityList"]},{"Fn::FindInMap":["FlightInstanceDescriptors",{"Fn::FindInMap":["FlightLoginTypes",{"Ref":"LoginInstanceType"},"InstanceDescriptor"]},"Key"]}]}]},"KeyName":{"Ref":"AccessKeyName"},"UserData":{"Fn::Base64":{"Fn::Join":["",["#cloud-config\n",{"Fn::If":["HasProfileOptions",{"Fn::Join":[" ",["#=FlightProfiles",{"Fn::If":["HasProfileBucket",{"Fn::Join":["",["s3://",{"Ref":"FlightProfileBucket"}]]},""]},{"Ref":"FlightProfiles"},"\n"]]},""]},{"Fn::Join":[" ",["#=FlightFeatures",{"Ref":"FlightFeatures"},{"Ref":"FlightSchedulerType"},{"Fn::If":["HasDiscreteVolumes","configure-discrete-volumes",""]},"\n"]]},"system_info:\n","  default_user:\n","    name: ",{"Ref":"AccessUsername"},"\n","write_files:\n","- content: |\n","    cluster:\n","      name: '",{"Ref":"AWS::StackName"},"'\n","      host_naming: 'allocate'\n","      hostname: 'login1'\n","      role: 'master'\n","      aws_signal_url: '",{"Ref":"FlightReadyHandle"},"'\n","      tags:\n","        scheduler_roles: ':master:'\n","        storage_roles: ':master:'\n","        access_roles: ':master:'\n","      ",{"Fn::If":["HasAutoscaling","autoscaling: enabled\n","autoscaling: disabled\n"]},{"Fn::If":["HasGridwareDepot",{"Fn::Join":["",["      gridware:\n","        trigger: immediate\n","        depots:\n","          - name: ",{"Ref":"FlightPreloadSoftware"},"\n"]]},""]},{"Fn::Join":["",["      identity: '",{"Ref":"AWS::StackId"},"'\n"]]},"  owner: root:root\n","  path: /opt/clusterware/etc/config.yml\n","  permissions: '0640'\n"]]}}}},"FlightPrivateRouteTable":{"Type":"AWS::EC2::RouteTable","Properties":{"VpcId":{"Ref":"FlightVPC"},"Tags":[{"Key":"Application","Value":{"Ref":"AWS::StackId"}}]}},"FlightPrivateRoute":{"Type":"AWS::EC2::Route","Properties":{"RouteTableId":{"Ref":"FlightPrivateRouteTable"},"DestinationCidrBlock":"0.0.0.0/0","InstanceId":{"Ref":"FlightLogin"}}},"FlightPrivateNetworkAcl":{"Type":"AWS::EC2::NetworkAcl","Properties":{"VpcId":{"Ref":"FlightVPC"}}},"FlightPrivateNetworkAclRuleIngress":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"Egress":false,"CidrBlock":"10.75.128.0/24","Protocol":"-1","RuleAction":"allow","RuleNumber":"100"}},"FlightPrivateNetworkAclRuleIngress2":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"Egress":false,"CidrBlock":"10.75.0.0/16","Protocol":"-1","RuleAction":"deny","RuleNumber":"200"}},"FlightPrivateNetworkAclRuleIngress3":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"Egress":false,"CidrBlock":"0.0.0.0/0","Protocol":"-1","RuleAction":"allow","RuleNumber":"300"}},"FlightPrivateNetworkAclRuleEgress":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"Egress":true,"CidrBlock":"10.75.128.0/24","Protocol":"-1","RuleAction":"allow","RuleNumber":"100"}},"FlightPrivateNetworkAclRuleEgress2":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"Egress":true,"CidrBlock":"10.75.0.0/16","Protocol":"-1","RuleAction":"deny","RuleNumber":"200"}},"FlightPrivateNetworkAclRuleEgress3":{"Type":"AWS::EC2::NetworkAclEntry","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"Egress":true,"CidrBlock":"0.0.0.0/0","Protocol":"-1","RuleAction":"allow","RuleNumber":"300"}},"FlightPrivateNetworkAclAssoc":{"Type":"AWS::EC2::SubnetNetworkAclAssociation","Properties":{"NetworkAclId":{"Ref":"FlightPrivateNetworkAcl"},"SubnetId":{"Ref":"FlightPrivateSubnet"}}},"FlightPrivateSubnet":{"Type":"AWS::EC2::Subnet","Properties":{"VpcId":{"Ref":"FlightVPC"},"CidrBlock":"10.75.129.0/24","Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-prv-subnet"]]}}],"AvailabilityZone":{"Fn::GetAtt":["FlightPublicSubnet","AvailabilityZone"]}}},"FlightPrivateRouteAssoc":{"Type":"AWS::EC2::SubnetRouteTableAssociation","Properties":{"SubnetId":{"Ref":"FlightPrivateSubnet"},"RouteTableId":{"Ref":"FlightPrivateRouteTable"}}},"FlightComputeIAMRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]},"Action":["sts:AssumeRole"]}]}}},"FlightComputeAutoscalingPolicy":{"Type":"AWS::IAM::Policy","Condition":"HasAutoscaling","Properties":{"PolicyName":"ComputeAutoscaling","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["autoscaling:DescribeAutoScalingGroups"],"Resource":["*"]}]},"Roles":[{"Ref":"FlightComputeIAMRole"}]}},"FlightComputeBucketPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyName":"ComputeBucketAccess","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:ListBucket","s3:GetObject"],"Resource":{"Fn::If":["HasProfileBucket",["arn:aws:s3:::alces-flight-*","arn:aws:s3:::alces-flight-*/*",{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"FlightProfileBucket"}]]},{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"FlightProfileBucket"},"/*"]]}],["arn:aws:s3:::alces-flight-*","arn:aws:s3:::alces-flight-*/*"]]}}]},"Roles":[{"Ref":"FlightComputeIAMRole"}]}},"FlightComputeIAMProfile":{"Type":"AWS::IAM::InstanceProfile","Properties":{"Path":"/","Roles":[{"Ref":"FlightComputeIAMRole"}]}},"FlightComputeSG":{"Type":"AWS::EC2::SecurityGroup","Properties":{"Tags":[{"Key":"Name","Value":{"Ref":"AWS::StackName"}}],"GroupDescription":"Enable access from the master to the Alces Clusterware compute nodes","VpcId":{"Ref":"FlightVPC"},"SecurityGroupIngress":[{"IpProtocol":"-1","FromPort":"0","ToPort":"65535","CidrIp":"10.75.0.0/16"}],"SecurityGroupEgress":[{"IpProtocol":"-1","FromPort":"0","ToPort":"65535","CidrIp":"0.0.0.0/0"}]}},"FlightComputeGroupConfig":{"Type":"AWS::AutoScaling::LaunchConfiguration","Properties":{"AssociatePublicIpAddress":"False","KeyName":{"Ref":"AccessKeyName"},"ImageId":{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AMI"]},"IamInstanceProfile":{"Ref":"FlightComputeIAMProfile"},"InstanceType":{"Fn::If":["HasSpot",{"Fn::If":["HasComputeInstanceTypeOther",{"Fn::FindInMap":["FlightSpotAvailability",{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AvailabilityList"]},{"Fn::FindInMap":["FlightInstanceDescriptors",{"Ref":"ComputeInstanceTypeOther"},"Key"]}]},{"Fn::FindInMap":["FlightInstanceTypeAvailability",{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AvailabilityList"]},{"Fn::FindInMap":["FlightInstanceDescriptors",{"Fn::FindInMap":["FlightComputeTypes",{"Ref":"ComputeInstanceType"},"InstanceDescriptor"]},"Key"]}]}]},{"Fn::If":["HasComputeInstanceTypeOther",{"Fn::FindInMap":["FlightInstanceTypeAvailability",{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AvailabilityList"]},{"Fn::FindInMap":["FlightInstanceDescriptors",{"Ref":"ComputeInstanceTypeOther"},"Key"]}]},{"Fn::FindInMap":["FlightInstanceTypeAvailability",{"Fn::FindInMap":["FlightRegionParameters",{"Ref":"AWS::Region"},"AvailabilityList"]},{"Fn::FindInMap":["FlightInstanceDescriptors",{"Fn::FindInMap":["FlightComputeTypes",{"Ref":"ComputeInstanceType"},"InstanceDescriptor"]},"Key"]}]}]}]},"BlockDeviceMappings":[{"DeviceName":"/dev/sda1","Ebs":{"VolumeSize":"20","VolumeType":{"Fn::FindInMap":["DiskTypes",{"Ref":"ComputeSystemVolumeType"},"VolumeType"]}}},{"DeviceName":"/dev/xvdb","VirtualName":"ephemeral0"},{"DeviceName":"/dev/xvdc","VirtualName":"ephemeral1"},{"DeviceName":"/dev/xvdd","VirtualName":"ephemeral2"},{"DeviceName":"/dev/xvde","VirtualName":"ephemeral3"}],"SpotPrice":{"Fn::If":["HasSpot",{"Ref":"ComputeSpotPrice"},{"Ref":"AWS::NoValue"}]},"SecurityGroups":[{"Ref":"FlightComputeSG"}],"UserData":{"Fn::Base64":{"Fn::Join":["",["#cloud-config\n",{"Fn::If":["HasProfileOptions",{"Fn::Join":[" ",["#=FlightProfiles",{"Fn::If":["HasProfileBucket",{"Fn::Join":["",["s3://",{"Ref":"FlightProfileBucket"}]]},""]},{"Ref":"FlightProfiles"},"\n"]]},""]},{"Fn::Join":[" ",["#=FlightFeatures",{"Ref":"FlightFeatures"},{"Ref":"FlightSchedulerType"},"\n"]]},"system_info:\n","  default_user:\n","    name: ",{"Ref":"AccessUsername"},"\n","write_files:\n","- content: |\n","    cluster:\n","      name: '",{"Ref":"AWS::StackName"},"'\n","      role: 'slave'\n","      master: ",{"Fn::GetAtt":["FlightLogin","PrivateIp"]},"\n","      tags:\n","        scheduler_roles: ':compute:'\n",{"Fn::Join":["",["      identity: '",{"Ref":"AWS::StackId"},"'\n"]]},"  owner: root:root\n","  path: /opt/clusterware/etc/config.yml\n","  permissions: '0640'\n"]]}}}},"FlightComputeGroup":{"Type":"AWS::AutoScaling::AutoScalingGroup","DependsOn":["FlightLogin"],"Properties":{"DesiredCapacity":{"Fn::If":["HasAutoscaling",{"Ref":"ComputeInitialNodes"},{"Ref":"ComputeMaxNodes"}]},"LaunchConfigurationName":{"Ref":"FlightComputeGroupConfig"},"PlacementGroup":{"Fn::If":["HasComputePlacement",{"Ref":"FlightPlacementGroup"},{"Ref":"AWS::NoValue"}]},"Tags":[{"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-compute"]]},"PropagateAtLaunch":"true"}],"MinSize":{"Fn::If":["HasZeroNodes","0","1"]},"MaxSize":{"Ref":"ComputeMaxNodes"},"VPCZoneIdentifier":[{"Ref":"FlightPrivateSubnet"}]}},"FlightComputeGroupScalingPolicy":{"Type":"AWS::AutoScaling::ScalingPolicy","Condition":"HasAutoscaling","Properties":{"AdjustmentType":"ChangeInCapacity","AutoScalingGroupName":{"Ref":"FlightComputeGroup"},"Cooldown":"300","ScalingAdjustment":"4"}},"FlightComputeGroupScalingAlarm":{"Type":"AWS::CloudWatch::Alarm","Condition":"HasAutoscaling","Properties":{"AlarmDescription":"Scale-up if current required nodes exceeds limit","MetricName":"NodesReq","Namespace":"ALCES-SCHEDULING","Statistic":"Average","Period":"60","EvaluationPeriods":"3","Threshold":"0","AlarmActions":[{"Ref":"FlightComputeGroupScalingPolicy"}],"Dimensions":[{"Name":"AutoScalingGroupName","Value":{"Ref":"FlightComputeGroup"}}],"ComparisonOperator":"GreaterThanThreshold"}}},"Outputs":{"Username":{"Description":"Administrator username used to log in to your environment with. This should be used in conjunction with your selected AWS keypair - together with the provided access IP.","Value":{"Ref":"AccessUsername"}},"AccessIP":{"Description":"Public access IP for your Flight Compute environment. Use together with your chosen username to gain SSH access.","Value":{"Fn::GetAtt":["FlightLogin","PublicIp"]}},"WebAccess":{"Description":"Web server address for your Flight Compute environment.","Value":{"Fn::Join":["",["http://",{"Fn::GetAtt":["FlightLogin","PublicDnsName"]}]]}}}}
